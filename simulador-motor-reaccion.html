<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Motor de Reacción - NASA Modernizado</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --primary: #3b82f6;
            /* Blue */
            --accent: #8b5cf6;
            /* Purple */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 40%);
        }

        /* --- Header --- */
        header {
            padding: 1rem 2rem;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        /* --- Main Layout --- */
        main {
            flex: 1;
            display: grid;
            grid-template-rows: 1fr 340px;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        /* --- Visualization Area --- */
        #viz-container {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .viz-labels {
            position: absolute;
            top: 1rem;
            left: 1rem;
            pointer-events: none;
        }

        .tag {
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            backdrop-filter: blur(4px);
            display: inline-block;
        }

        /* --- Dashboard Area (Bottom) --- */
        #dashboard {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 1rem;
        }

        .panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            overflow-y: auto;
        }

        .panel-header {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* --- Controls --- */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        .control-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: transform 0.1s;
            border: 2px solid var(--bg-dark);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            width: 100%;
            outline: none;
        }

        /* --- Stats Grid --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-unit {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 2px;
        }

        /* --- Bar Charts --- */
        .chart-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 100px;
            gap: 4px;
            padding-top: 1rem;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .bar {
            width: 100%;
            background: var(--accent);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
            min-height: 2px;
            opacity: 0.8;
        }

        .bar-label {
            font-size: 0.65rem;
            margin-top: 4px;
            color: var(--text-muted);
        }

        .station-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .station-table th {
            text-align: left;
            color: var(--text-muted);
            padding: 4px;
        }

        .station-table td {
            padding: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .station-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }
    </style>
</head>

<body>

    <header>
        <h1>AeroSim <span style="font-weight: 300; opacity: 0.7;">| Advanced Engine Simulator</span></h1>
        <div style="font-size: 0.875rem; color: var(--text-muted);">Baseado en NASA EngineSim 1.8a Logic</div>
    </header>

    <main>
        <!-- Top: Engine Visualization -->
        <div id="viz-container">
            <div class="viz-labels">
                <div class="tag">Visualization: Flow Velocity</div>
            </div>
            <canvas id="engineCanvas"></canvas>
        </div>

        <!-- Bottom: Dashboard -->
        <div id="dashboard">

            <!-- Left: Controls -->
            <div class="panel">
                <div class="panel-header">Controles de Vuelo</div>

                <div class="control-group">
                    <label class="control-label">Motor</label>
                    <select id="engineType">
                        <option value="1">Turbojet</option>
                        <option value="2">Turbofan</option>
                        <option value="3">Ramjet</option>
                    </select>
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Velocidad (Mach)</span>
                        <span class="control-value" id="val-mach">0.00</span>
                    </div>
                    <input type="range" id="input-mach" min="0" max="4.0" step="0.01" value="0.0">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Altitud (ft)</span>
                        <span class="control-value" id="val-alt">0</span>
                    </div>
                    <input type="range" id="input-alt" min="0" max="60000" step="500" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Acelerador (%)</span>
                        <span class="control-value" id="val-throttle">100</span>
                    </div>
                    <input type="range" id="input-throttle" min="40" max="100" step="1" value="100">
                </div>
            </div>

            <!-- Middle: Main Stats -->
            <div class="panel">
                <div class="panel-header">Rendimiento</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Empuje Neto (Fnet)</div>
                        <div style="color: var(--success);" class="stat-value" id="out-thrust">0</div>
                        <div class="stat-unit">lbs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Consumo (Fuel Flow)</div>
                        <div style="color: var(--warning);" class="stat-value" id="out-fuel">0</div>
                        <div class="stat-unit">lbs/hr</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">TSFC</div>
                        <div class="stat-value" id="out-tsfc">0.00</div>
                        <div class="stat-unit">lb/hr/lb</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Airflow</div>
                        <div class="stat-value" id="out-airflow">0.0</div>
                        <div class="stat-unit">pps</div>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <div class="panel-header" style="border:none; padding-bottom:0;">Presión (Ratio) por Estación</div>
                    <div class="chart-container" id="pressure-chart">
                        <!-- Bars generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Right: Cycle Analysis -->
            <div class="panel">
                <div class="panel-header">Análisis de Ciclo (Termodinámica)</div>
                <table class="station-table">
                    <thead>
                        <tr>
                            <th>Estación</th>
                            <th>Temp (R)</th>
                            <th>Pres (psi)</th>
                        </tr>
                    </thead>
                    <tbody id="station-data">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>

        </div>
    </main>

    <script>
        /**
         * EngineSim JS Port
         * Ported from NASA Turbo.java logic
         */
        const Sim = {
            // Constants
            GAMOPT: 1, // Variable gamma
            G0: 32.2,
            RGAS: 1718.0,

            // State
            inputs: {
                mach: 0.0,
                alt: 0.0, // feet
                throttle: 100.0,
                engType: 1 // 1=Turbojet, 2=Turbofan, 3=Ramjet
            },

            // Engine Design Parameters (Default: Turbojet)
            design: {
                prat: { 2: 1.0, 3: 12.0, 4: 1.0, 5: 1.0, 7: 1.0, 13: 1.5, 15: 1.0 }, // Pressure Ratios
                eta: { 2: 1.0, 3: 0.85, 4: 1.0, 5: 0.9, 7: 1.0, 13: 1.0 }, // Efficiencies
                tt4: 2500.0, // Turbine Inlet Temp (Rankine) Design
                tt7: 2500.0, // Afterburner Temp
                fhv: 18600.0, // Fuel heating value
                acore: 2.0, // Core Area sq ft
                byprat: 0.0, // Bypass Ratio
                afan: 2.0 // Fan Area
            },

            // Calculated Station Data
            stations: {
                0: { t: 0, p: 0 }, // Freestream
                2: { t: 0, p: 0 }, // Inlet
                3: { t: 0, p: 0 }, // Compressor Exit
                4: { t: 0, p: 0 }, // Burner Exit
                5: { t: 0, p: 0 }, // Turbine Exit
                8: { t: 0, p: 0 }  // Nozzle Throat
            },

            // Outputs
            outputs: {
                fnet: 0,
                fuelFlow: 0,
                sfc: 0,
                airflow: 0
            },

            // --- Physics Library (Ported from Turbo.java) ---

            getGama: function (temp) {
                // Gamma as function of Rankine
                const a = -7.6942651e-13;
                const b = 1.3764661e-08;
                const c = -7.8185709e-05;
                const d = 1.436914;
                return a * temp * temp * temp + b * temp * temp + c * temp + d;
            },

            getCp: function (temp) {
                // Cp as function of Rankine
                const a = -4.4702130e-13;
                const b = -5.1286514e-10;
                const c = 2.8323331e-05;
                const d = 0.2245283;
                return a * temp * temp * temp + b * temp * temp + c * temp + d;
            },

            getAir: function (mach, gamma) {
                // Corrected airflow per area: function(Mach)
                const fac2 = (gamma + 1.0) / (2.0 * (gamma - 1.0));
                const fac1 = Math.pow((1.0 + 0.5 * (gamma - 1.0) * mach * mach), fac2);
                return 0.50161 * Math.sqrt(gamma) * mach / fac1;
            },

            getMach: function (sub, corair, gamma) {
                // Iterate to find Mach from A/A* (corair)
                let number = 0;
                let chokair = this.getAir(1.0, gamma);

                if (corair > chokair) return 1.0;

                let airo = 0.25618;
                let macho = (sub === 1) ? 1.0 : (sub === 2 ? 1.703 : 0.5);
                let iter = 1;
                let machn = macho - 0.2;
                let deriv, airn;

                while (Math.abs(corair - airo) > 0.0001 && iter < 20) {
                    airn = this.getAir(machn, gamma);
                    deriv = (airn - airo) / (machn - macho);
                    airo = airn;
                    macho = machn;
                    machn = macho + (corair - airo) / deriv;
                    iter++;
                }
                return macho;
            },

            // --- Main Simulation Loop ---

            calculate: function () {
                let { mach, alt, throttle, engType } = this.inputs;
                const d = this.design;

                // 1. Atmosphere (Standard Day)
                let ts0, ps0;
                if (alt < 36152) {
                    ts0 = 518.6 - 3.56 * alt / 1000.0;
                    ps0 = 2116.0 * Math.pow(ts0 / 518.6, 5.256);
                } else { // Stratosphere
                    ts0 = 389.98;
                    ps0 = 2116.0 * 0.2236 * Math.exp((36000.0 - alt) / (53.35 * 389.98));
                }

                let a0 = Math.sqrt(1.4 * this.RGAS * ts0);
                let u0 = mach * a0; // true airspeed

                // Input Stagnation Conditions
                let tt0 = ts0 * (1.0 + 0.5 * (1.4 - 1.0) * mach * mach);
                let pt0 = ps0 * Math.pow(tt0 / ts0, 3.5);

                this.stations[0] = { t: tt0, p: pt0 };

                // 2. Inlet Recovery (Mil Spec)
                let eta_r = 1.0;
                if (mach > 1.0) eta_r = 1.0 - 0.075 * Math.pow(mach - 1.0, 1.35);

                // Station 2 (Compressor Face)
                let tt2 = tt0;
                let pt2 = pt0 * eta_r;
                this.stations[2] = { t: tt2, p: pt2 };

                // 3. Compressor / Fan Logic
                let tt3, pt3, tt4, pt4, tt5, pt5, tt13, pt13;
                let WorkComp, WorkFan;

                // --- Setup Engine Types ---
                // Turbojet
                if (engType == 1) {
                    d.byprat = 0.0;
                    d.prat[3] = 12.0;
                    d.afan = d.acore;
                }
                // Turbofan
                else if (engType == 2) {
                    d.byprat = 1.0; // High bypass
                    d.prat[3] = 12.0;
                    d.prat[13] = 1.5; // Fan pressure ratio
                    d.afan = d.acore * (1.0 + d.byprat);
                }
                // Ramjet
                else if (engType == 3) {
                    d.byprat = 0.0;
                    d.prat[3] = 1.0; // No compressor
                    d.acore = 1.75; // Ramjet geometry
                }


                if (engType <= 2) { // Rotating Machinery

                    // Fan (if exists) or Inlet
                    let gam2 = this.getGama(tt2);
                    let cp2 = this.getCp(tt2);

                    // Fan Stage (Station 13)
                    let prat13 = (engType == 2) ? 1.5 : 1.0;
                    let delhf = 0;

                    if (engType == 2) {
                        let delt_fan = (tt2 / d.eta[13]) * (Math.pow(prat13, (gam2 - 1) / gam2) - 1.0);
                        tt13 = tt2 + delt_fan;
                        pt13 = pt2 * prat13;
                        delhf = cp2 * delt_fan;
                    } else {
                        tt13 = tt2;
                        pt13 = pt2;
                    }

                    // Compressor Stage (Station 3)
                    // Simplified: Assuming design pres ratio holds approx const (basic cycle)
                    let prat3 = d.prat[3];
                    // Adjust compressor map for off-design (very simplified)
                    // Ideally would use map, here we stick to design point for basics

                    let gam13 = this.getGama(tt13);
                    let cp13 = this.getCp(tt13);

                    let delt_comp = (tt13 / d.eta[3]) * (Math.pow(prat3, (gam13 - 1) / gam13) - 1.0);

                    tt3 = tt13 + delt_comp;
                    pt3 = pt13 * prat3;

                    WorkComp = cp13 * delt_comp;
                    WorkFan = delhf; // BTU/lbm

                    this.stations[3] = { t: tt3, p: pt3 };

                    // 4. Burner (Station 4)
                    tt4 = d.tt4 * (throttle / 100.0); // Simple throttle model
                    let prat4 = 0.95; // Burner pressure loss
                    pt4 = pt3 * prat4;

                    this.stations[4] = { t: tt4, p: pt4 };

                    // 5. Turbine (Station 5)
                    // Work Balance: Turbine Work = Compressor Work + Fan Work * BPR
                    // delH_turb = delH_comp + BPR * delH_fan

                    let gam4 = this.getGama(tt4);
                    let cp4 = this.getCp(tt4);

                    let totalCompWork = WorkComp + d.byprat * WorkFan;

                    // Turbine Enthalpy Drop
                    let delt_turb = totalCompWork / ((1.0 + 0.02) * cp4); // Neglecting fuel mass for moment, 0.02 fa roughly

                    tt5 = tt4 - delt_turb;
                    // Turbine Expansion Ratio
                    let trat5 = tt5 / tt4;
                    let prat5 = Math.pow((1.0 - (1.0 / d.eta[5]) * (1.0 - trat5)), gam4 / (gam4 - 1.0));

                    pt5 = pt4 * prat5;

                    this.stations[5] = { t: tt5, p: pt5 };

                } else { // Ramjet
                    tt3 = tt2; pt3 = pt2;
                    tt4 = d.tt4 * (throttle / 100.0);
                    pt4 = pt3 * 0.95;
                    tt5 = tt4; pt5 = pt4; // No turbine

                    this.stations[3] = { t: tt3, p: pt3 };
                    this.stations[4] = { t: tt4, p: pt4 };
                    this.stations[5] = { t: tt5, p: pt5 };
                }

                // 6. Nozzle / Exhaust (Station 8)
                // Assume choked flow if pressure ratio is high enough
                let pt8 = pt5;
                let tt8 = tt5;

                // Performance Calculation (Thrust)
                // Gross Thrust = m_dot * (V_exit - V_free) + (P_exit - P_free) * A_exit

                // Calculate Exit Velocity
                let gam8 = this.getGama(tt8);
                let cp8 = this.getCp(tt8);
                let npr = pt8 / ps0; // Nozzle Pressure Ratio

                let M8 = 0;
                let P8 = ps0;

                // Check choking
                let critical_pr = Math.pow((gam8 + 1) / 2, gam8 / (gam8 - 1));

                if (npr > critical_pr) {
                    M8 = 1.0; // Choked
                    const chokeFactor = Math.pow((gam8 + 1) / 2, -gam8 / (gam8 - 1));
                    P8 = pt8 * chokeFactor;
                } else {
                    // Fully expanded
                    P8 = ps0;
                    M8 = Math.sqrt((2 / (gam8 - 1)) * (Math.pow(npr, (gam8 - 1) / gam8) - 1));
                }

                // Velocity Exit
                let ts8 = tt8 / (1 + 0.5 * (gam8 - 1) * M8 * M8);
                let a8_sound = Math.sqrt(gam8 * this.RGAS * ts8);
                let u8 = M8 * a8_sound;

                // Airflow Calculation (lbs/sec)
                // Based on Mach = 0.5 at Compressor face or similar constraint
                // Here, we simplify: Airflows is proportional to P and density
                let rho0 = ps0 * 144 / (this.RGAS * ts0);

                // Corrected Airflow Reference
                let airflow = 100.0 * (pt2 / 2116.0) * Math.sqrt(518.6 / tt2); // Baseline engine size
                if (engType == 3) airflow = 50.0 * (pt2 / 2116.0); // Smaller Ramjet

                // Thrust Equation
                // F = m_dot * (V_exit - V_0) / g0 + (P8 - P0)*A8

                // Calc Area Exit (A8) derived from mass flow continuity at throat
                // m_dot = rho * V * A
                let rho8 = P8 * 144 / (this.RGAS * ts8);
                let A8 = (airflow / this.G0) / (rho8 * u8); // sq ft

                let m_dot_slugs = airflow / this.G0;

                let fgross = m_dot_slugs * u8 + (P8 - ps0) * 144 * A8;
                let fdump = m_dot_slugs * u0; // Ram drag

                // Bypass Contribution (Turbofan)
                let fnet_core = fgross - fdump;
                let fnet_total = fnet_core;

                if (engType == 2) {
                    // Fan Nozzle
                    let pt_fan_exit = pt13;
                    let tt_fan_exit = tt13;
                    let npr_fan = pt_fan_exit / ps0;
                    let u_fan = 0;
                    if (npr_fan > 1.0) {
                        let gam_fan = 1.4;
                        u_fan = Math.sqrt(2 * this.RGAS * tt_fan_exit * (1 - Math.pow(1 / npr_fan, (gam_fan - 1) / gam_fan))); // Ideal expansion
                    }
                    let m_fan_slugs = m_dot_slugs * d.byprat;
                    let fnet_fan = m_fan_slugs * (u_fan - u0);
                    fnet_total += fnet_fan;
                    airflow *= (1.0 + d.byprat);
                }

                if (engType == 3 && mach < 0.5) fnet_total = 0; // Ramjet needs speed

                this.outputs.fnet = fnet_total;
                this.outputs.airflow = airflow;

                // Fuel Flow
                // Energy balance: m_fuel * HV = m_air * Cp * (T4 - T3)
                let cp_comb = 0.24;
                let heat_needed = (airflow / (1 + d.byprat)) * cp_comb * (tt4 - tt3);
                if (engType == 2) heat_needed = (airflow / (1 + d.byprat)) * cp_comb * (tt4 - tt3);

                let fuel_flow_sec = heat_needed / d.fhv; // lbs/sec
                this.outputs.fuelFlow = fuel_flow_sec * 3600.0; // lbs/hr

                this.outputs.sfc = (fnet_total > 1) ? this.outputs.fuelFlow / fnet_total : 0;

                this.updateStations(tt0, pt0);
            },

            updateStations: function (tt0, pt0) {
                // Nothing complex, just ensure station 8 is recorded
            }
        };

        // --- UI Controller ---
        const UI = {
            init: function () {
                // Inputs
                this.els = {
                    mach: document.getElementById('input-mach'),
                    alt: document.getElementById('input-alt'),
                    throttle: document.getElementById('input-throttle'),
                    engType: document.getElementById('engineType'),

                    // Labels
                    lblMach: document.getElementById('val-mach'),
                    lblAlt: document.getElementById('val-alt'),
                    lblThrottle: document.getElementById('val-throttle'),

                    // Outputs
                    outThrust: document.getElementById('out-thrust'),
                    outFuel: document.getElementById('out-fuel'),
                    outTsfc: document.getElementById('out-tsfc'),
                    outAirflow: document.getElementById('out-airflow'),

                    // Charts
                    stationTable: document.getElementById('station-data'),
                    pressureChart: document.getElementById('pressure-chart')
                };

                // Listeners
                const update = () => this.update();
                this.els.mach.addEventListener('input', update);
                this.els.alt.addEventListener('input', update);
                this.els.throttle.addEventListener('input', update);
                this.els.engType.addEventListener('change', update);

                // Initial Loop
                this.update();
                this.animate();
            },

            update: function () {
                // Sync Inputs
                Sim.inputs.mach = parseFloat(this.els.mach.value);
                Sim.inputs.alt = parseFloat(this.els.alt.value);
                Sim.inputs.throttle = parseFloat(this.els.throttle.value);
                Sim.inputs.engType = parseInt(this.els.engType.value);

                // Update Labels
                this.els.lblMach.textContent = Sim.inputs.mach.toFixed(2);
                this.els.lblAlt.textContent = Sim.inputs.alt.toLocaleString();
                this.els.lblThrottle.textContent = Sim.inputs.throttle.toFixed(0) + '%';

                // Run Physics
                Sim.calculate();

                // Update Outputs
                this.els.outThrust.textContent = Math.round(Sim.outputs.fnet).toLocaleString();
                this.els.outFuel.textContent = Math.round(Sim.outputs.fuelFlow).toLocaleString();
                this.els.outTsfc.textContent = Sim.outputs.sfc.toFixed(3);
                this.els.outAirflow.textContent = Sim.outputs.airflow.toFixed(1);

                // Update Tables & Charts
                this.renderStationData();
            },

            renderStationData: function () {
                const s = Sim.stations;
                const order = [0, 2, 3, 4, 5];
                const labels = ["Amb", "Inlet", "Comp", "Burn", "Turb"];

                // Table
                let html = '';
                order.forEach((idx, i) => {
                    if (s[idx]) {
                        html += `<tr>
                            <td>${labels[i]}</td>
                            <td>${Math.round(s[idx].t)}</td>
                            <td>${(s[idx].p / 144.0).toFixed(2)}</td>
                        </tr>`;
                    }
                });
                this.els.stationTable.innerHTML = html;

                // Pressure Chart
                // Normalize to max pressure
                let maxP = 0;
                order.forEach(i => { if (s[i] && s[i].p > maxP) maxP = s[i].p; });

                let bars = '';
                order.forEach((idx, i) => {
                    if (s[idx]) {
                        // Avoid div by zero
                        let h = (maxP > 0) ? (s[idx].p / maxP) * 100 : 0;
                        if (h < 2) h = 2;
                        bars += `
                        <div class="bar-group">
                            <div class="bar" style="height: ${h}%"></div>
                            <div class="bar-label">${labels[i]}</div>
                        </div>`;
                    }
                });
                this.els.pressureChart.innerHTML = bars;
            },

            animate: function () {
                Renderer.draw();
                requestAnimationFrame(() => this.animate());
            }
        };

        // --- Canvas Renderer ---
        const Renderer = {
            canvas: document.getElementById('engineCanvas'),
            ctx: null,
            particles: [],

            init: function () {
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.initParticles();
            },

            initParticles: function () {
                this.particles = [];
                for (let i = 0; i < 100; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height * 0.4 + this.canvas.height * 0.3,
                        speed: Math.random() * 2 + 2,
                        size: Math.random() * 2 + 1
                    });
                }
            },

            resize: function () {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                this.initParticles();
            },

            draw: function () {
                const w = this.canvas.width;
                const h = this.canvas.height;
                const ctx = this.ctx;

                // Clear
                ctx.clearRect(0, 0, w, h);

                // Draw Engine Schematic (Simplified Section)
                const cy = h / 2;

                // Engine Component Colors based on Temperature
                const s = Sim.stations;
                const getTempColor = (t) => {
                    // t ranges roughly 400 (blue) to 3000 (red)
                    const n = Math.min(Math.max((t - 400) / 2500, 0), 1);
                    // Blue to Red gradient
                    const r = Math.floor(n * 255);
                    const b = Math.floor((1 - n) * 255);
                    return `rgba(${r}, 50, ${b}, 0.5)`;
                };

                // Define Zones geometry (percent width)
                const zones = [
                    { x: 0.1, w: 0.15, t: s[2].t, n: "Inlet" },
                    { x: 0.25, w: 0.2, t: s[3].t, n: "Comp" },
                    { x: 0.45, w: 0.1, t: s[4].t, n: "Burn" },
                    { x: 0.55, w: 0.15, t: s[5].t, n: "Turb" },
                    { x: 0.70, w: 0.1, t: s[5].t, n: "Noz" }
                ];

                // Draw Outline
                ctx.strokeStyle = "rgba(255,255,255,0.2)";
                ctx.lineWidth = 2;

                // Draw Casing
                ctx.beginPath();
                // Top line
                ctx.moveTo(w * 0.1, cy - 60);
                ctx.lineTo(w * 0.25, cy - 50); // Inlet compression
                ctx.lineTo(w * 0.45, cy - 50); // Comp
                ctx.lineTo(w * 0.55, cy - 60); // Burn exp
                ctx.lineTo(w * 0.8, cy - 50); // Nozzle
                // Bottom line
                ctx.moveTo(w * 0.1, cy + 60);
                ctx.lineTo(w * 0.25, cy + 50);
                ctx.lineTo(w * 0.45, cy + 50);
                ctx.lineTo(w * 0.55, cy + 60);
                ctx.lineTo(w * 0.8, cy + 50);

                ctx.stroke();

                // Fill Zones
                zones.forEach(z => {
                    ctx.fillStyle = getTempColor(z.t);
                    const zx = z.x * w;
                    const zw = z.w * w;
                    // Draw rect for zone
                    ctx.fillRect(zx, cy - 45, zw, 90);

                    // Label
                    ctx.fillStyle = "white";
                    ctx.font = "10px Inter";
                    ctx.fillText(z.n, zx + 5, cy + 55);
                });

                // Fan (if Turbofan)
                if (Sim.inputs.engType == 2) {
                    ctx.fillStyle = "rgba(100, 200, 255, 0.2)";
                    ctx.fillRect(w * 0.1, cy - 90, w * 0.7, 25); // Top bypass
                    ctx.fillRect(w * 0.1, cy + 65, w * 0.7, 25); // Bottom bypass
                    ctx.fillStyle = "white";
                    ctx.fillText("Bypass", w * 0.15, cy - 75);
                }

                // Draw Core Shaft
                ctx.fillStyle = "#555";
                ctx.fillRect(w * 0.25, cy - 2, w * 0.3, 4);

                // --- Flow Animation ---
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";

                // Flow speed proportional to inputs and position
                const mach = Sim.inputs.mach;
                const fan_speed = Sim.inputs.throttle / 100;

                this.particles.forEach(p => {
                    // Update P
                    // Speed var based on zone
                    let localSpeed = p.speed * (1 + mach);
                    // If in engine (x > 0.1w and x < 0.8w), accelerate
                    if (p.x > w * 0.45 && p.x < w * 0.8) localSpeed *= 2; // Combustion acceleration

                    p.x += localSpeed;
                    if (p.x > w) p.x = 0;

                    // Draw
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
        };

        // Initialize
        Renderer.init();
        UI.init();

    </script>
</body>

</html>
