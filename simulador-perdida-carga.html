<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de P√©rdida de Carga en Tuber√≠as</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #424c75 0%, #764ba2 100%);
            color: #2d3748;
            min-height: 100vh;
            padding: 20px;
        }

        .watermark-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('logo_UCA.png');
            background-repeat: repeat;
            background-size: 300px;
            opacity: 0.03;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        .equation-display {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin-top: 0.3rem;
            font-family: 'Courier New', monospace;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.5rem;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: #2d3748;
            font-weight: 700;
        }

        .section-title {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }

        .visualization-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .results-card {
            padding: 1rem;
        }

        .equation-box {
            margin-top: 0.75rem;
            padding: 0.6rem;
            background: #f7fafc;
            border-radius: 6px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        #pipeCanvas {
            width: 100%;
            height: 320px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: block;
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .controls-panel::-webkit-scrollbar {
            width: 4px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Material Selector */
        .material-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .material-btn {
            padding: 0.5rem 0.3rem;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            color: #475569;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .material-btn:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
        }

        .material-btn.active {
            background: #667eea;
            border-color: #5a67d8;
            color: white;
        }

        .control-group {
            margin-bottom: 0.6rem;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
            color: #4a5568;
            font-weight: 600;
        }

        .control-value {
            font-family: 'Courier New', monospace;
            color: #2d3748;
            font-size: 0.8rem;
            background: #f7fafc;
            padding: 1px 4px;
            border-radius: 4px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #64748b;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .slider-btn {
            width: 28px;
            height: 28px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            color: #475569;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .slider-btn:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
        }

        /* Accessories Section */
        .accessories-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 0.75rem;
            margin-top: 0.5rem;
        }

        .accessory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .accessory-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }

        .accessory-label {
            font-size: 0.7rem;
            color: #4a5568;
        }

        .accessory-counter {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: #f7fafc;
            border-radius: 6px;
            padding: 3px;
            border: 1px solid #e2e8f0;
        }

        .accessory-btn {
            width: 24px;
            height: 24px;
            background: #edf2f7;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            color: #4a5568;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .accessory-btn:hover {
            background: #e2e8f0;
            border-color: #94a3b8;
        }

        .accessory-count {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            min-width: 20px;
            text-align: center;
            color: #2d3748;
        }

        .reset-btn {
            width: 100%;
            padding: 0.6rem;
            background: #fff5f5;
            border: 1px solid #fc8181;
            border-radius: 6px;
            color: #c53030;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            background: #fed7d7;
            border-color: #ef4444;
        }

        /* Output Grid */
        .output-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        .output-item {
            background: #f7fafc;
            padding: 0.6rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .output-item.highlight {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
        }

        .output-label {
            font-size: 0.65rem;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.2rem;
            font-weight: 600;
        }

        .output-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
            font-family: 'Courier New', monospace;
        }

        .output-unit {
            font-size: 0.7rem;
            color: #718096;
            font-weight: 400;
            margin-left: 1px;
        }

        @media (max-width: 900px) {
            .output-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .output-item.highlight {
                grid-column: span 3;
            }
        }

        .flow-regime {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.3rem;
        }

        .flow-regime.laminar {
            background: #f0fff4;
            color: #2f855a;
        }

        .flow-regime.transition {
            background: #fffff0;
            color: #b7791f;
        }

        .flow-regime.turbulent {
            background: #fff5f5;
            color: #c53030;
        }

        /* Pressure Scale Legend */
        .pressure-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .legend-label {
            font-size: 0.75rem;
            color: #4a5568;
            font-weight: 600;
        }

        .legend-gradient {
            width: 120px;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #ef4444);
        }

        /* K Total Badge */
        .k-total-badge {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.6rem;
            background: #ebf8ff;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #90cdf4;
        }

        .k-total-badge span:first-child {
            color: #2c5282;
            font-weight: 600;
        }

        .k-total-badge span:last-child {
            font-family: 'Courier New', monospace;
            color: #2b6cb0;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="watermark-pattern"></div>
    <div class="container">
        <header>
            <h1>üîß Simulador de P√©rdida de Carga en Tuber√≠as</h1>
            <p class="subtitle">Ecuaci√≥n de Darcy-Weisbach y P√©rdidas Menores</p>
        </header>

        <a href="index.html" class="back-button">Volver al Inicio</a>

        <div class="main-layout">
            <!-- Visualization Panel -->
            <div class="visualization-column">
                <div class="card">
                    <div class="card-title">Visualizaci√≥n del Flujo</div>
                    <canvas id="pipeCanvas"></canvas>
                    <div class="pressure-legend">
                        <span class="legend-label">Alta Presi√≥n</span>
                        <div class="legend-gradient"></div>
                        <span class="legend-label">Baja Presi√≥n</span>
                    </div>
                </div>

                <!-- Results Grid - Below Animation -->
                <div class="card results-card">
                    <div class="card-title">Resultados</div>
                    <div class="output-grid">
                        <div class="output-item">
                            <div class="output-label">Reynolds (Re)</div>
                            <div class="output-value" id="reynoldsValue">200,000</div>
                            <span class="flow-regime turbulent" id="flowRegime">Turbulento</span>
                        </div>
                        <div class="output-item">
                            <div class="output-label">Factor Fricci√≥n (f)</div>
                            <div class="output-value" id="frictionValue">0.0185</div>
                        </div>
                        <div class="output-item">
                            <div class="output-label">P√©rdida Fricci√≥n</div>
                            <div class="output-value"><span id="frictionLossValue">3.77</span><span
                                    class="output-unit">m</span></div>
                        </div>
                        <div class="output-item">
                            <div class="output-label">P√©rdida Accesorios</div>
                            <div class="output-value"><span id="accessoryLossValue">0.00</span><span
                                    class="output-unit">m</span></div>
                        </div>
                        <div class="output-item highlight">
                            <div class="output-label">P√©rdida Total (h<sub>f</sub>)</div>
                            <div class="output-value"><span id="totalLossValue">3.77</span><span
                                    class="output-unit">m</span></div>
                        </div>
                    </div>
                    <div class="equation-box">
                        h<sub>f</sub> = f ¬∑ (L/D) ¬∑ (V¬≤/2g) + Œ£K ¬∑ (V¬≤/2g)
                    </div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="card controls-panel">
                <div class="card-title">Par√°metros</div>

                <!-- Material Selector -->
                <div class="material-selector">
                    <button class="material-btn" data-roughness="0.0015">PVC</button>
                    <button class="material-btn active" data-roughness="0.045">Acero</button>
                    <button class="material-btn" data-roughness="0.15">Hierro</button>
                    <button class="material-btn" data-roughness="0.26">Galv.</button>
                </div>

                <!-- Length Control -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Longitud (L)</span>
                        <span class="control-value" id="lengthValue">10 m</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-btn" id="lengthDown">‚àí</button>
                        <input type="range" id="lengthSlider" min="1" max="50" value="10" step="1">
                        <button class="slider-btn" id="lengthUp">+</button>
                    </div>
                </div>

                <!-- Diameter Control -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Di√°metro (D)</span>
                        <span class="control-value" id="diameterValue">100 mm</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-btn" id="diameterDown">‚àí</button>
                        <input type="range" id="diameterSlider" min="20" max="300" value="100" step="5">
                        <button class="slider-btn" id="diameterUp">+</button>
                    </div>
                </div>

                <!-- Velocity Control -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Velocidad (V)</span>
                        <span class="control-value" id="velocityValue">2.0 m/s</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-btn" id="velocityDown">‚àí</button>
                        <input type="range" id="velocitySlider" min="0.1" max="10" value="2" step="0.1">
                        <button class="slider-btn" id="velocityUp">+</button>
                    </div>
                </div>

                <!-- Viscosity Control -->
                <div class="control-group">
                    <div class="control-label">
                        <span>Viscosidad (ŒΩ)</span>
                        <span class="control-value" id="viscosityValue">1.0 cSt</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-btn" id="viscosityDown">‚àí</button>
                        <input type="range" id="viscositySlider" min="0.5" max="100" value="1" step="0.5">
                        <button class="slider-btn" id="viscosityUp">+</button>
                    </div>
                </div>

                <!-- Accessories -->
                <div class="accessories-section">
                    <div class="section-title">Accesorios</div>
                    <div class="accessory-grid">
                        <div class="accessory-item">
                            <span class="accessory-label">Codos 90¬∞</span>
                            <div class="accessory-counter">
                                <button class="accessory-btn" onclick="changeAccessory('elbows', -1)">‚àí</button>
                                <span class="accessory-count" id="elbowsCount">0</span>
                                <button class="accessory-btn" onclick="changeAccessory('elbows', 1)">+</button>
                            </div>
                        </div>
                        <div class="accessory-item">
                            <span class="accessory-label">V√°lvulas</span>
                            <div class="accessory-counter">
                                <button class="accessory-btn" onclick="changeAccessory('valves', -1)">‚àí</button>
                                <span class="accessory-count" id="valvesCount">0</span>
                                <button class="accessory-btn" onclick="changeAccessory('valves', 1)">+</button>
                            </div>
                        </div>
                        <div class="accessory-item">
                            <span class="accessory-label">Entradas</span>
                            <div class="accessory-counter">
                                <button class="accessory-btn" onclick="changeAccessory('entries', -1)">‚àí</button>
                                <span class="accessory-count" id="entriesCount">0</span>
                                <button class="accessory-btn" onclick="changeAccessory('entries', 1)">+</button>
                            </div>
                        </div>
                        <div class="accessory-item">
                            <span class="accessory-label">Salidas</span>
                            <div class="accessory-counter">
                                <button class="accessory-btn" onclick="changeAccessory('exits', -1)">‚àí</button>
                                <span class="accessory-count" id="exitsCount">0</span>
                                <button class="accessory-btn" onclick="changeAccessory('exits', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="k-total-badge">
                        <span>K total:</span>
                        <span id="totalK">0.00</span>
                    </div>
                </div>

                <button class="reset-btn" id="resetBtn">Restablecer</button>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('pipeCanvas');
        const ctx = canvas.getContext('2d');

        // Parameters
        let params = {
            length: 10,
            diameter: 100,
            velocity: 2,
            viscosity: 1,
            roughness: 0.045,
            elbows: 0,
            valves: 0,
            entries: 0,
            exits: 0
        };

        // K values for accessories
        const kValues = {
            elbows: 0.9,
            valves: 0.2,
            entries: 0.5,
            exits: 1.0
        };

        // Particles
        let particles = [];
        const maxParticles = 120;

        // Sliders
        const lengthSlider = document.getElementById('lengthSlider');
        const diameterSlider = document.getElementById('diameterSlider');
        const velocitySlider = document.getElementById('velocitySlider');
        const viscositySlider = document.getElementById('viscositySlider');

        // Slider buttons mapping
        const sliderButtons = {
            length: { down: 'lengthDown', up: 'lengthUp', slider: lengthSlider },
            diameter: { down: 'diameterDown', up: 'diameterUp', slider: diameterSlider },
            velocity: { down: 'velocityDown', up: 'velocityUp', slider: velocitySlider },
            viscosity: { down: 'viscosityDown', up: 'viscosityUp', slider: viscositySlider }
        };

        class Particle {
            constructor(pipeStart, pipeEnd, pipeTop, pipeBottom) {
                this.reset(pipeStart, pipeEnd, pipeTop, pipeBottom, true);
            }

            reset(pipeStart, pipeEnd, pipeTop, pipeBottom, randomX = false) {
                this.x = randomX ? pipeStart + Math.random() * (pipeEnd - pipeStart) : pipeStart + Math.random() * 30;
                this.y = pipeTop + Math.random() * (pipeBottom - pipeTop);
                this.baseSpeed = 0.8 + Math.random() * 0.4;
                this.size = 2 + Math.random() * 2;
                this.alpha = 0.5 + Math.random() * 0.4;
                this.wobble = Math.random() * Math.PI * 2;
                this.wobbleSpeed = 0.02 + Math.random() * 0.02;
            }

            update(pipeStart, pipeEnd, pipeTop, pipeBottom, velocity) {
                const speed = this.baseSpeed * velocity * 1.2;
                this.x += speed;
                this.wobble += this.wobbleSpeed;

                // Turbulent wobble
                const reynolds = calculateReynolds();
                if (reynolds > 4000) {
                    const wobbleAmount = Math.min((reynolds - 4000) / 80000, 0.4);
                    this.y += Math.sin(this.wobble) * wobbleAmount;
                }

                // Keep within pipe
                const centerY = (pipeTop + pipeBottom) / 2;
                const pipeRadius = (pipeBottom - pipeTop) / 2 - this.size;
                const distFromCenter = this.y - centerY;
                if (Math.abs(distFromCenter) > pipeRadius) {
                    this.y = centerY + Math.sign(distFromCenter) * pipeRadius;
                }

                if (this.x > pipeEnd) {
                    this.reset(pipeStart, pipeEnd, pipeTop, pipeBottom, false);
                }
            }

            draw(ctx, pipeStart, pipeEnd) {
                const t = (this.x - pipeStart) / (pipeEnd - pipeStart);
                const color = getGradientColor(t);
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${this.alpha})`;
                ctx.fill();
            }
        }

        function getGradientColor(t) {
            const colors = [
                { r: 59, g: 130, b: 246 },
                { r: 139, g: 92, b: 246 },
                { r: 236, g: 72, b: 153 },
                { r: 239, g: 68, b: 68 }
            ];

            const totalLoss = calculateTotalLoss();
            const pressureDrop = Math.min(t * (totalLoss / 12), 1);

            const segment = pressureDrop * (colors.length - 1);
            const i = Math.floor(segment);
            const f = segment - i;

            if (i >= colors.length - 1) return colors[colors.length - 1];

            return {
                r: Math.round(colors[i].r + (colors[i + 1].r - colors[i].r) * f),
                g: Math.round(colors[i].g + (colors[i + 1].g - colors[i].g) * f),
                b: Math.round(colors[i].b + (colors[i + 1].b - colors[i].b) * f)
            };
        }

        // Calculations
        function calculateReynolds() {
            const D = params.diameter / 1000;
            const nu = params.viscosity * 1e-6;
            return (params.velocity * D) / nu;
        }

        function calculateFrictionFactor() {
            const Re = calculateReynolds();
            const D = params.diameter;
            const epsilon = params.roughness;
            const relRoughness = epsilon / D;

            if (Re < 2300) {
                return 64 / Re;
            } else {
                const term1 = relRoughness / 3.7;
                const term2 = 5.74 / Math.pow(Re, 0.9);
                return 0.25 / Math.pow(Math.log10(term1 + term2), 2);
            }
        }

        function calculateFrictionLoss() {
            const f = calculateFrictionFactor();
            const L = params.length;
            const D = params.diameter / 1000;
            const V = params.velocity;
            const g = 9.81;
            return f * (L / D) * (V * V) / (2 * g);
        }

        function calculateTotalK() {
            return params.elbows * kValues.elbows +
                params.valves * kValues.valves +
                params.entries * kValues.entries +
                params.exits * kValues.exits;
        }

        function calculateAccessoryLoss() {
            const K = calculateTotalK();
            const V = params.velocity;
            const g = 9.81;
            return K * (V * V) / (2 * g);
        }

        function calculateTotalLoss() {
            return calculateFrictionLoss() + calculateAccessoryLoss();
        }

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            initParticles();
        }

        function initParticles() {
            const rect = canvas.getBoundingClientRect();
            const pipeStart = 60;
            const pipeEnd = rect.width - 60;
            const centerY = rect.height / 2;
            const pipeHeight = Math.min(params.diameter * 0.6, 100);
            const pipeTop = centerY - pipeHeight / 2;
            const pipeBottom = centerY + pipeHeight / 2;

            particles = [];
            for (let i = 0; i < maxParticles; i++) {
                particles.push(new Particle(pipeStart, pipeEnd, pipeTop, pipeBottom));
            }
        }

        function drawAccessory(ctx, type, x, centerY, pipeHeight) {
            const h = pipeHeight;
            ctx.save();
            ctx.translate(x, centerY);

            switch (type) {
                case 'elbow':
                    ctx.strokeStyle = '#fbbf24';
                    ctx.lineWidth = 2.5;
                    ctx.beginPath();
                    ctx.arc(0, 0, h * 0.25, -Math.PI / 2, 0);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(h * 0.15, -h * 0.08);
                    ctx.lineTo(h * 0.25, 0);
                    ctx.lineTo(h * 0.15, h * 0.08);
                    ctx.stroke();
                    break;

                case 'valve':
                    ctx.fillStyle = 'rgba(236, 72, 153, 0.7)';
                    ctx.beginPath();
                    ctx.moveTo(-h * 0.12, -h * 0.35);
                    ctx.lineTo(h * 0.12, 0);
                    ctx.lineTo(-h * 0.12, h * 0.35);
                    ctx.closePath();
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(h * 0.12, -h * 0.35);
                    ctx.lineTo(-h * 0.12, 0);
                    ctx.lineTo(h * 0.12, h * 0.35);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#ec4899';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, -h * 0.35);
                    ctx.lineTo(0, -h * 0.5);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(0, -h * 0.55, h * 0.08, 0, Math.PI * 2);
                    ctx.stroke();
                    break;

                case 'entry':
                    ctx.strokeStyle = '#4ade80';
                    ctx.lineWidth = 2.5;
                    ctx.beginPath();
                    ctx.moveTo(-h * 0.25, -h * 0.45);
                    ctx.lineTo(0, -h * 0.3);
                    ctx.moveTo(-h * 0.25, h * 0.45);
                    ctx.lineTo(0, h * 0.3);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-h * 0.1, 0);
                    ctx.lineTo(h * 0.05, -h * 0.08);
                    ctx.moveTo(-h * 0.1, 0);
                    ctx.lineTo(h * 0.05, h * 0.08);
                    ctx.stroke();
                    break;

                case 'exit':
                    ctx.strokeStyle = '#a78bfa';
                    ctx.lineWidth = 2.5;
                    ctx.beginPath();
                    ctx.moveTo(0, -h * 0.3);
                    ctx.lineTo(h * 0.25, -h * 0.45);
                    ctx.moveTo(0, h * 0.3);
                    ctx.lineTo(h * 0.25, h * 0.45);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(h * 0.08, -h * 0.08);
                    ctx.lineTo(h * 0.2, 0);
                    ctx.lineTo(h * 0.08, h * 0.08);
                    ctx.stroke();
                    break;
            }
            ctx.restore();
        }

        function draw() {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            ctx.clearRect(0, 0, width, height);

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // Pipe dimensions
            const pipeStart = 60;
            const pipeEnd = width - 60;
            const pipeLength = pipeEnd - pipeStart;
            const centerY = height / 2;
            const pipeHeight = Math.min(params.diameter * 0.6, 100);
            const pipeTop = centerY - pipeHeight / 2;
            const pipeBottom = centerY + pipeHeight / 2;

            // Pipe gradient
            const totalLoss = calculateTotalLoss();
            const normalizedLoss = Math.min(totalLoss / 12, 1);

            const gradient = ctx.createLinearGradient(pipeStart, 0, pipeEnd, 0);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.25)');
            gradient.addColorStop(normalizedLoss * 0.4, 'rgba(139, 92, 246, 0.25)');
            gradient.addColorStop(normalizedLoss * 0.7, 'rgba(236, 72, 153, 0.25)');
            gradient.addColorStop(Math.min(normalizedLoss, 1), 'rgba(239, 68, 68, 0.25)');

            // Draw pipe body
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.roundRect(pipeStart, pipeTop, pipeLength, pipeHeight, 6);
            ctx.fill();

            // Pipe border gradient
            const borderGradient = ctx.createLinearGradient(pipeStart, 0, pipeEnd, 0);
            borderGradient.addColorStop(0, '#3b82f6');
            borderGradient.addColorStop(normalizedLoss * 0.5, '#8b5cf6');
            borderGradient.addColorStop(normalizedLoss, '#ef4444');

            ctx.strokeStyle = borderGradient;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(pipeStart, pipeTop, pipeLength, pipeHeight, 6);
            ctx.stroke();

            // Draw accessories
            const totalAccessories = params.elbows + params.valves + params.entries + params.exits;
            if (totalAccessories > 0) {
                let accessoryIndex = 0;
                const spacing = pipeLength / (totalAccessories + 1);

                for (let i = 0; i < params.entries; i++) {
                    accessoryIndex++;
                    drawAccessory(ctx, 'entry', pipeStart + spacing * accessoryIndex, centerY, pipeHeight);
                }
                for (let i = 0; i < params.elbows; i++) {
                    accessoryIndex++;
                    drawAccessory(ctx, 'elbow', pipeStart + spacing * accessoryIndex, centerY, pipeHeight);
                }
                for (let i = 0; i < params.valves; i++) {
                    accessoryIndex++;
                    drawAccessory(ctx, 'valve', pipeStart + spacing * accessoryIndex, centerY, pipeHeight);
                }
                for (let i = 0; i < params.exits; i++) {
                    accessoryIndex++;
                    drawAccessory(ctx, 'exit', pipeStart + spacing * accessoryIndex, centerY, pipeHeight);
                }
            }

            // Update and draw particles
            particles.forEach(p => {
                p.update(pipeStart + 5, pipeEnd - 5, pipeTop + 4, pipeBottom - 4, params.velocity);
                p.draw(ctx, pipeStart, pipeEnd);
            });

            // Flow arrow
            ctx.fillStyle = 'rgba(100, 116, 139, 0.2)';
            ctx.beginPath();
            ctx.moveTo(pipeEnd - 50, centerY - 12);
            ctx.lineTo(pipeEnd - 30, centerY);
            ctx.lineTo(pipeEnd - 50, centerY + 12);
            ctx.closePath();
            ctx.fill();

            // Labels
            ctx.font = 'bold 11px system-ui';
            ctx.fillStyle = '#4a5568';
            ctx.textAlign = 'center';
            ctx.fillText('ENTRADA', pipeStart, pipeTop - 12);
            ctx.fillText('P‚ÇÅ', pipeStart, pipeBottom + 20);
            ctx.fillText('SALIDA', pipeEnd, pipeTop - 12);
            ctx.fillText('P‚ÇÇ', pipeEnd, pipeBottom + 20);

            // Length indicator
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(pipeStart, pipeBottom + 40);
            ctx.lineTo(pipeEnd, pipeBottom + 40);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.moveTo(pipeStart, pipeBottom + 35);
            ctx.lineTo(pipeStart, pipeBottom + 45);
            ctx.moveTo(pipeEnd, pipeBottom + 35);
            ctx.lineTo(pipeEnd, pipeBottom + 45);
            ctx.stroke();

            ctx.fillStyle = '#4a5568';
            ctx.fillText(`L = ${params.length} m`, (pipeStart + pipeEnd) / 2, pipeBottom + 55);

            // Diameter label
            ctx.textAlign = 'right';
            ctx.fillText(`D = ${params.diameter} mm`, pipeStart - 10, centerY + 4);

            // Velocity indicator
            const arrowLen = 50;
            const arrowX = pipeStart - 80;
            ctx.strokeStyle = '#d69e2e';
            ctx.fillStyle = '#d69e2e';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(arrowX, centerY);
            ctx.lineTo(arrowX + arrowLen, centerY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(arrowX + arrowLen, centerY);
            ctx.lineTo(arrowX + arrowLen - 8, centerY - 5);
            ctx.lineTo(arrowX + arrowLen - 8, centerY + 5);
            ctx.closePath();
            ctx.fill();
            ctx.font = '10px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText(`V = ${params.velocity.toFixed(1)} m/s`, arrowX + arrowLen / 2, centerY - 12);

            requestAnimationFrame(draw);
        }

        function updateUI() {
            // Update value displays
            document.getElementById('lengthValue').textContent = `${params.length} m`;
            document.getElementById('diameterValue').textContent = `${params.diameter} mm`;
            document.getElementById('velocityValue').textContent = `${params.velocity.toFixed(1)} m/s`;
            document.getElementById('viscosityValue').textContent = `${params.viscosity.toFixed(1)} cSt`;

            // Calculate results
            const Re = calculateReynolds();
            const f = calculateFrictionFactor();
            const hf = calculateFrictionLoss();
            const hm = calculateAccessoryLoss();
            const hT = calculateTotalLoss();
            const K = calculateTotalK();

            // Update results
            document.getElementById('reynoldsValue').textContent = Re.toLocaleString('es-ES', { maximumFractionDigits: 0 });

            const regimeEl = document.getElementById('flowRegime');
            if (Re < 2300) {
                regimeEl.textContent = 'Laminar';
                regimeEl.className = 'flow-regime laminar';
            } else if (Re < 4000) {
                regimeEl.textContent = 'Transici√≥n';
                regimeEl.className = 'flow-regime transition';
            } else {
                regimeEl.textContent = 'Turbulento';
                regimeEl.className = 'flow-regime turbulent';
            }

            document.getElementById('frictionValue').textContent = f.toFixed(4);
            document.getElementById('frictionLossValue').textContent = hf.toFixed(2);
            document.getElementById('accessoryLossValue').textContent = hm.toFixed(2);
            document.getElementById('totalLossValue').textContent = hT.toFixed(2);
            document.getElementById('totalK').textContent = K.toFixed(2);
        }

        function changeAccessory(type, delta) {
            params[type] = Math.max(0, Math.min(5, params[type] + delta));
            document.getElementById(type + 'Count').textContent = params[type];
            updateUI();
        }

        // Event Listeners
        lengthSlider.addEventListener('input', (e) => {
            params.length = parseFloat(e.target.value);
            updateUI();
        });

        diameterSlider.addEventListener('input', (e) => {
            params.diameter = parseFloat(e.target.value);
            updateUI();
            initParticles();
        });

        velocitySlider.addEventListener('input', (e) => {
            params.velocity = parseFloat(e.target.value);
            updateUI();
        });

        viscositySlider.addEventListener('input', (e) => {
            params.viscosity = parseFloat(e.target.value);
            updateUI();
        });

        // Slider buttons
        Object.entries(sliderButtons).forEach(([param, buttons]) => {
            document.getElementById(buttons.down).addEventListener('click', () => {
                const slider = buttons.slider;
                const step = parseFloat(slider.step);
                const newValue = Math.max(parseFloat(slider.min), parseFloat(slider.value) - step);
                slider.value = newValue;
                slider.dispatchEvent(new Event('input'));
            });

            document.getElementById(buttons.up).addEventListener('click', () => {
                const slider = buttons.slider;
                const step = parseFloat(slider.step);
                const newValue = Math.min(parseFloat(slider.max), parseFloat(slider.value) + step);
                slider.value = newValue;
                slider.dispatchEvent(new Event('input'));
            });
        });

        // Material buttons
        document.querySelectorAll('.material-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                params.roughness = parseFloat(e.target.dataset.roughness);
                updateUI();
            });
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            params = {
                length: 10,
                diameter: 100,
                velocity: 2,
                viscosity: 1,
                roughness: 0.045,
                elbows: 0,
                valves: 0,
                entries: 0,
                exits: 0
            };

            lengthSlider.value = 10;
            diameterSlider.value = 100;
            velocitySlider.value = 2;
            viscositySlider.value = 1;

            document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-roughness="0.045"]').classList.add('active');

            document.getElementById('elbowsCount').textContent = '0';
            document.getElementById('valvesCount').textContent = '0';
            document.getElementById('entriesCount').textContent = '0';
            document.getElementById('exitsCount').textContent = '0';

            updateUI();
            initParticles();
        });

        window.addEventListener('resize', resizeCanvas);

        // Initialize
        resizeCanvas();
        updateUI();
        draw();
    </script>
</body>

</html>